@startuml
' ───────────────────────────────────────────────────────────
skin rose
autonumber

actor  Customer
participant "Frontend SPA / Mobile" as FRONT
participant "Marketplace App (Monolith)" as APP
participant "Stripe" as STRIPE
participant "Seller 1" as SELLER1
participant "Seller 2" as SELLER2
participant "Delivery Provider" as DELIVERY

'═══════════════════════════════════════════════════════════
== 1. Add products to cart ==
Customer  -> FRONT : Click “Add to Cart” (Prod-A, Prod-B)
FRONT     -> APP   : POST /api/cart {items[…]}

note right
APP does:
 • validate items / stock  
 • upsert cart rows  
 • calculate cart summary
end note

APP       --> FRONT : 201 Created + cart summary

'═══════════════════════════════════════════════════════════
== 2. Checkout ==
Customer  -> FRONT : Click “Checkout”
FRONT     -> APP   : POST /api/checkout   (no body)

APP :*group* Build order in-memory
  APP -> APP : split cart items by seller  
  APP -> APP : create Order + OrderItems (status =pending)
end group

APP        -> STRIPE : Create Checkout Session (amount, split by seller†)
STRIPE     --> APP   : checkout_session{ id, url }

APP        --> FRONT : 200 OK { payment_url }

'═══════════════════════════════════════════════════════════
== 3. Customer pays on Stripe ==
Customer  -> STRIPE : Pays with card
STRIPE    -> APP    : **Webhook** payment_intent.succeeded

APP :*group* Payment webhook handling
  APP -> APP : mark Order & OrderItems as **paid**
  APP -> SELLER1 : POST /api/orders/new    (notify)
  APP -> SELLER2 : POST /api/orders/new
  APP -> DELIVERY: Create delivery tasks
end group

APP        --> STRIPE : 200 OK (webhook ack)

'═══════════════════════════════════════════════════════════
== 4. Partial cancellation / refund ==
Customer  -> FRONT : “Cancel Item #123” (seller 1)
FRONT     -> APP   : POST /api/orders/items/123/cancel

APP :*group* Validate & cancel
  APP -> STRIPE : Create partial refund (item amount, seller 1)
  STRIPE --> APP : refund succeeded
  APP -> APP : mark OrderItem as **cancelled**
  APP -> SELLER1 : POST /api/orders/cancelled
  APP -> DELIVERY: cancel shipment (if not sent)
end group

APP        --> FRONT : 200 OK { refund_confirmed:true }

'═══════════════════════════════════════════════════════════
== 5. Stripe automatic payouts ==
Stripe nightly process
STRIPE --> SELLER2 : Transfer funds for paid items (payout)

@enduml